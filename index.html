<!DOCTYPE html>
<html>
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, interactive-widget=resizes-content">
      <meta name="theme-color" content="#000000">
      <meta name="mobile-web-app-capable" content="yes">
      <meta name="mobile-web-app-status-bar-style" content="default">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="apple-mobile-web-app-status-bar-style" content="default">
      <meta name="apple-mobile-web-app-title" content="Grid Golf">
      <meta name="description" content="A small golf board game">
      <title>Zig Zag Rush</title>
      <link rel="icon" type="image/ico" href="favicon.ico">
      <link rel="shortcut icon" type="image/png" href="images/icon-192.png">
      <link rel="shortcut icon" sizes="192x192" href="images/icon-192.png">
      <link rel="apple-touch-icon" href="images/icon-192.png">
      <link rel="apple-touch-icon" href="images/icon-172.png">
      <link rel="apple-touch-icon" sizes="76x76" href="images/icon-76.png">
      <link rel="apple-touch-icon" sizes="120x120" href="images/icon-120.png">
      <link rel="apple-touch-icon" sizes="152x152" href="images/icon-152.png">
      <link rel="apple-touch-icon" sizes="180x180" href="images/icon-180.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 440px) and (device-height: 956px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="splash_screens/iPhone_16_Pro_Max_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 402px) and (device-height: 874px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="splash_screens/iPhone_16_Pro_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="splash_screens/iPhone_16_Plus__iPhone_15_Pro_Max__iPhone_15_Plus__iPhone_14_Pro_Max_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="splash_screens/iPhone_16__iPhone_15_Pro__iPhone_15__iPhone_14_Pro_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="splash_screens/iPhone_14_Plus__iPhone_13_Pro_Max__iPhone_12_Pro_Max_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="splash_screens/iPhone_14__iPhone_13_Pro__iPhone_13__iPhone_12_Pro__iPhone_12_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="splash_screens/iPhone_13_mini__iPhone_12_mini__iPhone_11_Pro__iPhone_XS__iPhone_X_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="splash_screens/iPhone_11_Pro_Max__iPhone_XS_Max_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="splash_screens/iPhone_11__iPhone_XR_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="splash_screens/iPhone_8_Plus__iPhone_7_Plus__iPhone_6s_Plus__iPhone_6_Plus_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="splash_screens/iPhone_8__iPhone_7__iPhone_6s__iPhone_6__4.7__iPhone_SE_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="splash_screens/4__iPhone_SE__iPod_touch_5th_generation_and_later_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 1032px) and (device-height: 1376px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="splash_screens/13__iPad_Pro_M4_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="splash_screens/12.9__iPad_Pro_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1210px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="splash_screens/11__iPad_Pro_M4_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="splash_screens/11__iPad_Pro__10.5__iPad_Pro_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="splash_screens/10.9__iPad_Air_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="splash_screens/10.5__iPad_Air_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="splash_screens/10.2__iPad_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="splash_screens/9.7__iPad_Pro__7.9__iPad_mini__9.7__iPad_Air__9.7__iPad_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="splash_screens/8.3__iPad_Mini_landscape.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 440px) and (device-height: 956px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="splash_screens/iPhone_16_Pro_Max_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 402px) and (device-height: 874px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="splash_screens/iPhone_16_Pro_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="splash_screens/iPhone_16_Plus__iPhone_15_Pro_Max__iPhone_15_Plus__iPhone_14_Pro_Max_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="splash_screens/iPhone_16__iPhone_15_Pro__iPhone_15__iPhone_14_Pro_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="splash_screens/iPhone_14_Plus__iPhone_13_Pro_Max__iPhone_12_Pro_Max_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="splash_screens/iPhone_14__iPhone_13_Pro__iPhone_13__iPhone_12_Pro__iPhone_12_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="splash_screens/iPhone_13_mini__iPhone_12_mini__iPhone_11_Pro__iPhone_XS__iPhone_X_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="splash_screens/iPhone_11_Pro_Max__iPhone_XS_Max_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="splash_screens/iPhone_11__iPhone_XR_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="splash_screens/iPhone_8_Plus__iPhone_7_Plus__iPhone_6s_Plus__iPhone_6_Plus_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="splash_screens/iPhone_8__iPhone_7__iPhone_6s__iPhone_6__4.7__iPhone_SE_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="splash_screens/4__iPhone_SE__iPod_touch_5th_generation_and_later_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 1032px) and (device-height: 1376px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="splash_screens/13__iPad_Pro_M4_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="splash_screens/12.9__iPad_Pro_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1210px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="splash_screens/11__iPad_Pro_M4_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="splash_screens/11__iPad_Pro__10.5__iPad_Pro_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="splash_screens/10.9__iPad_Air_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="splash_screens/10.5__iPad_Air_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="splash_screens/10.2__iPad_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="splash_screens/9.7__iPad_Pro__7.9__iPad_mini__9.7__iPad_Air__9.7__iPad_portrait.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="splash_screens/8.3__iPad_Mini_portrait.png">
      <link rel="stylesheet" href="style.css">
      <link rel="manifest" href="manifest.json">
      <script src="enums.js"></script>
      <script src="constants.js"></script>
      <script src="rectangle.js"></script>
      <script src="player.js"></script>
      <script src="track.js"></script>
      <script src="smokeparticle.js"></script>
      <script src="tree.js"></script>
      <script src="house.js"></script>
     </head>
   <body style="margin: 0px; overflow: hidden">
      <div id="metersDiv" style="position:absolute; top:5px; right:5px; font-size: 5vw;"></div>
      <div id="highscoreDiv" style="position:absolute; top:5px; left:5px; font-size: 5vw;">Highscore: 0 m</div>
      <canvas id="myCanvas" style="background-color: green"></canvas>
      <div id="startGameButton" class="StartGame">Start&nbsp;Game</div>
      <div id="versionDiv" style="position:absolute; bottom:5px; left:5px; font-size: 2vw;">v1.4</div>
      <script>

         function resizeCanvas() {
            myCanvas.width = window.innerWidth;
            myCanvas.height = window.innerHeight;
         }

         let run = false;
         let lastTime;
         let metersDriven = 0.0;

         const ctx = myCanvas.getContext("2d");

         const shortSide = 1;
         const minLongSide = 3;
         const maxLongSide = 10;
         const N = 10;
         const speed = 30;
         let highscore = 0;
         let blinkInterval = null;

         let track = new Track(N, minLongSide, maxLongSide);

         let player = new Player(
            shortSide * blockSize + 50,
            shortSide * blockSize / 2,
            shortSide * blockSize / 10,
            speed
         );

         const audioContext = new (window.AudioContext || window.webkitAudioContext)();
         let skidBuffer;

         function loadSound(url) {
            return fetch(url)
               .then(response => response.arrayBuffer())
               .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer));
         }

         function playSound(buffer) {
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.start(0);
         }

         loadSound('sounds/skid.mp3').then(buffer => {
            skidBuffer = buffer;
         });

         function changeDir(event) {
            playSound(skidBuffer);
            player.changeDirection();
         }

         function loadHighscore() {
            if (localStorage.getItem("highscore") === null) {
               localStorage.setItem("highscore", 0);
            }
            highscore = Math.floor(localStorage.getItem("highscore") * 1);
            highscoreDiv.innerHTML = "Highscore: " + highscore + " m";
         }

         function saveHighscore() {
            localStorage.setItem("highscore", highscore);
         }

         function startBlinking() {
            if (blinkInterval === null) {
               blinkInterval = setInterval(() => {
                  highscoreDiv.style.visibility = (highscoreDiv.style.visibility === 'hidden' ? '' : 'hidden');
               }, 100);
            }
         }

         function stopBlinking() {
            if (blinkInterval !== null) {
               clearInterval(blinkInterval);
               blinkInterval = null;
               highscoreDiv.style.visibility = '';
            }
         }

         function screenTouch(event) {
            event.preventDefault();

            if (event.target && event.target.hasPointerCapture && event.target.hasPointerCapture(event.pointerId)) {
               event.target.releasePointerCapture(event.pointerId);
            }   

            if (run) {
               changeDir();
            } else {
               startGame();
            }
         }

         function startGame(timestamp) {
            track = new Track(N, minLongSide, maxLongSide);

            player = new Player(
               shortSide * blockSize + 50,
               shortSide * blockSize / 2,
               shortSide * blockSize / 10,
               speed
            );

            startGameButton.style.display = "none";
            run = true;
            stopBlinking();
            lastTime = Date.now();
            animate(lastTime);
         }

         function stopGame() {
            drawScreen();
            soundCrash.play();
            startGameButton.style.display = "block";
            run = false;
            saveHighscore();
            stopBlinking();
         }

         function drawScreen() {
            ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);

            ctx.save();
            ctx.translate(myCanvas.width / 2, myCanvas.height / 2);
            ctx.rotate(-3 * Math.PI / 4);

            ctx.translate(-player.x, -player.y);

            track.draw(ctx);
            player.draw(ctx);

            ctx.restore();
         }

         function animate(time) {
            var elapsed = Math.max(1, time - lastTime);
            lastTime = time;
            metersDiv.innerHTML = player.distance.toFixed(0) + " m";            
            if (player.distance > highscore) {
               highscore = player.distance;
               highscoreDiv.innerHTML = "Highscore: " + player.distance.toFixed(0) + " m";
               startBlinking();
            }
            player.move(elapsed);
            track.adjustFor(player);
            if (!track.contains(player)) {
               stopGame();
               return;
            }

            drawScreen();

            if (run)
            {
               requestAnimationFrame(animate);
            }
         }

         window.addEventListener('resize', resizeCanvas);
         document.addEventListener("pointerdown", (event) => { screenTouch(event); }); 
         document.addEventListener("keydown", (event) => { screenTouch(event); });
         window.addEventListener('selectstart', (event) => { event.preventDefault(); return false; });
         document.addEventListener('contextmenu', (event) => { event.preventDefault(); });
         resizeCanvas();
         loadHighscore();

         drawScreen();

      </script>
        <audio id="soundCrash" preload="auto">
            <source src="sounds/crash.mp3" type="audio/mpeg">
        </audio>
    
   </body>
</html>