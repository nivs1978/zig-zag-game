<!DOCTYPE html>
<html>
   <head>
      <title>ZigZag Game</title>
   </head>
   <body style="margin: 0px; overflow: hidden">
      <div id="metersDiv" style="position:absolute; top:5px; right:5px; font-size: 5vw;"></div>
      <div id="highscoreDiv" style="position:absolute; top:5px; left:5px; font-size: 5vw;">Highscore: 0 m</div>
      <canvas id="myCanvas" style="background-color: #cccccc"></canvas>
      <div id="startGameButton" class="StartGame">Start Game</div>
      <link rel="stylesheet" href="style.css">
      <script src="rectangle.js"></script>
      <script src="player.js"></script>
      <script src="track.js"></script>
      <script src="smokeparticle.js"></script>
      <script>

         function resizeCanvas() {
            myCanvas.width = window.innerWidth;
            myCanvas.height = window.innerHeight;
         }

         let run = false;
         let lastTime;
         let metersDriven = 0.0;
         let nextSign = 100;

         const ctx = myCanvas.getContext("2d");

         const shortSide = 100;
         const minLongSide = 300;
         const maxLongSide = 1000;
         const N = 10;
         const x = 0;
         const y = 0;
         const speed = 4;
         let track = null;
         let player = null;
         let highscore = 0;
         let blinkInterval = null;

         function changeDir() {
            soundSkid.pause();
            soundSkid.currentTime = 0
            soundSkid.play();
            player.changeDirection()
         }

         function bindTouchEvents() {
         }

         document.addEventListener("pointerdown", startGame );
         document.addEventListener("keydown", startGame );

         function loadHighscore() {
            if (localStorage.getItem("highscore") === null) {
               localStorage.setItem("highscore", 0);
            }
            highscore = Math.floor(localStorage.getItem("highscore") * 1);
            highscoreDiv.innerHTML = "Highscore: " + highscore + " m";
         }

         function saveHighscore() {
            localStorage.setItem("highscore", highscore);
         }

         function startBlinking() {
            if (blinkInterval === null) {
               blinkInterval = setInterval(() => {
                  highscoreDiv.style.visibility = (highscoreDiv.style.visibility === 'hidden' ? '' : 'hidden');
               }, 100);
            }
         }

         function stopBlinking() {
            if (blinkInterval !== null) {
               clearInterval(blinkInterval);
               blinkInterval = null;
               highscoreDiv.style.visibility = '';
            }
         }

         function startGame() {
            document.removeEventListener("pointerdown", startGame );
            document.removeEventListener("keydown", startGame );
            document.addEventListener("pointerdown", changeDir );
            document.addEventListener("keydown", changeDir );


            track = new Track(x, y , N, shortSide, minLongSide, maxLongSide);

            player = new Player(
               shortSide / 2,
               shortSide / 2,
               shortSide * 0.1,
               speed
            );

            metersDriven = 0.0;
            startGameButton.style.display = "none";
            run = true;
            lastTime = performance.now();
            stopBlinking();
            animate(lastTime);
         }

         function stopGame() {
            soundCrash.play();
            startGameButton.style.display = "block";
            run = false;
            saveHighscore();
            stopBlinking();
            document.removeEventListener("pointerdown", changeDir );
            document.removeEventListener("keydown", changeDir );
            document.addEventListener("pointerdown", startGame );
            document.addEventListener("keydown", startGame );
         }

         function animate(time) {
            var elapsed = time - lastTime;
            metersDriven += player.speed * elapsed / 20000;

            metersDiv.innerHTML = metersDriven.toFixed(0) + " m";            
            if (metersDriven > highscore) {
               highscore = metersDriven;
               highscoreDiv.innerHTML = "Highscore: " + metersDriven.toFixed(0) + " m";
               startBlinking();
            }
            player.move();
            player.speed += 0.005;
            track.adjustFor(player);
            if (!track.contains(player)) {
               stopGame();
               return;
            }

            ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);

            ctx.save();
            ctx.translate(myCanvas.width / 2, myCanvas.height / 2);
            ctx.rotate(-3 * Math.PI / 4);

            ctx.translate(-player.x, -player.y);

            track.draw(ctx);
            player.draw(ctx);

            ctx.restore();

            if (run)
            {
               requestAnimationFrame(animate);
            }
         }

         window.addEventListener('resize', resizeCanvas);

         resizeCanvas();
         loadHighscore();

      </script>
          <audio id="soundSkid" preload="auto">
            <source src="sounds/skid.mp3" type="audio/mpeg">
        </audio>
        <audio id="soundCrash" preload="auto">
            <source src="sounds/crash.mp3" type="audio/mpeg">
        </audio>
    
   </body>
</html>